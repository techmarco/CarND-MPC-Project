#**Model Predictive Control (MPC)**

### Implementation

#### The Model

##### Student describes their model in detail. This includes the state, actuators and update equations.

The kinematic model implemented in the MPC project has a state vector comprised of six components, an actuator vector comprised of two components, and one physical characteristic.

The state vector components are: $[x, y, \psi, v, cte, e\psi]$, representing x-position, y-position, heading, speed, cross track error, and heading error; respectively.

The actuator vector components are: $[\delta, a]$ representing steering angle and acceleration/braking; respectively. For acceleration/braking positive values imply acceleration and negative values imply braking.

Furthermore, the model includes a physical characteristic $L_f$ that represents the distance between the vehicle front axle and the center of gravity. In the project, this distance is set to 2.67 m.

The update equations used to determine the future state including vehicle location, heading, speed, cross track error and orientation error at timestep $t+1$ are as follows:

$x$~t+1~ = $x_t$ + $v_t$ * $cos$($\psi_t$) * $dt$

$y$~t+1~ = $y_t$ + $v_t$ * $cos$($\psi_t$) * $dt$

$\psi$~t+1~ = $\psi_t$ + $\frac{v_t}{L_f}$ * $cos$($\psi_t$) * $dt$

$v$~t+1~ = $v_t$ + $a_t$ * $dt$

$cte$~t+1~ = $f(x_t) - y_t + (v_t * sin(e\psi_t) * dt)$

$e\psi$~t+1~ = $e\psi_t + \frac{v_t}{L_f} * \delta_t * dt$

#### Timestep Length and Elapsed Duration (N & dt)

##### Student discusses the reasoning behind the chosen N (timestep length) and dt (elapsed duration between timesteps) values. Additionally the student details the previous values tried.

The selected values for the timestep length and elapsed duration are shown in the table below.

| N | dt |
| :-----: | :-----: |
| 8 | 0.1 |

The reason for the selection of the above hyperparameters was to balance the tradeoffs between computational cost and discretization error. With the selected parameters the time horizon $T$ is 0.8 seconds and proved to be reasonable to navigate the simulated track at a speed of 45 mph.

An attempt was made with doubling of the timestep length to 16 and halving of the elapsed duration to 0.05 seconds maintaining the same time horizon. This resulted in excessive corrections being made by the controller causing instability that led to the vehicle going off the roadway due to the 100 millisecond actuation lag. To confirm the hypothesis was correct, the actuation lag was removed and the car navigated the simulated track correction.

The opposite approach of halving the timestep length to 4 and doubling the elapsed duration to 0.2 seconds maintaining the same time horizon was attempted. This approach resulted in an immediate departure from the roadway due to the erroneous predictions produced by the algorithm.

#### Polynomial Fitting and MPC Preprocessing

##### A polynomial is fitted to waypoints. If the student preprocesses waypoints, the vehicle state, and/or actuators prior to the MPC procedure it is described.

The preprocessing completed on the waypoints to prepare them for the simulation was a transformation comprising a rotation and a translation from the global coordinate system to the local coordinate system. The transformation equations used are as follows:

$x_v = (x_p - x_c) * cos(\psi) + (y_p - y_c) * sin(\psi)$
$y_v = (y_p - y_c) * cos(\psi) - (x_p - x_c) * sin(\psi)$

A third order polynomial was fitted to the preprocessed waypoints as shown in yellow trajectory in the figure below. The green trajectory is the predicted trajectory generated by the controller.

#![MPC Project][image1]{width=60%}

#### Model Predictive Control with Latency

##### The student implements Model Predictive Control that handles a 100 millisecond latency. Student provides details on how they deal with latency.

The latency was handled through the selection of a timestep length hyperparameter equal to that of the 100 millisecond latency. This permitted the controller to generate predictions that inherently accounted for the latency.

Another method that could be used to handle the latency would be to account for it by computing the state 100 milliseconds into the future from the current state. This would effectively allow the current state to look ahead and generate predictions that account for the actuation lag.

[//]: # (Image References)

[image1]: /home/marco.nogueira/github/CarND-MPC-Project/doc/mpc.png "MPC Project"
